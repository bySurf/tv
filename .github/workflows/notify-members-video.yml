# Notify Discord Members Lounge when a new members video is available.
# Reads videos.json, finds the video with latest releaseDate, extracts episode ID,
# and POSTs to a Discord webhook with @Supporters and share link.
#
# Required repo secrets: DISCORD_WEBHOOK_URL, DISCORD_SUPPORTERS_ROLE_ID

name: Notify Members Video

on:
  push:
    branches: [main]
    paths: ['bysurf_tv_data.json']

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest episode ID
        id: episode
        run: |
          EPID=$(node -e '
          const fs = require("fs");
          const data = JSON.parse(fs.readFileSync("bysurf_tv_data.json", "utf8"));
          const videos = (data.videos || []).filter(v => v.releaseDate && String(v.releaseDate).trim());
          videos.sort((a, b) => new Date(b.releaseDate) - new Date(a.releaseDate));
          const latest = videos[0];
          if (!latest || !latest.url) process.exit(0);
          const m = latest.url.match(/\/(?:videos|video_embeds)\/(\d+)/);
          if (m) console.log(m[1]);
          ')
          echo "episode_id=$EPID" >> $GITHUB_OUTPUT
          echo "has_episode=$([ -n "$EPID" ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      # Wait until server.bysurf.tv has the new episode so share link meta tags work when Discord crawls
      - name: Wait for episode in server JSON
        if: steps.episode.outputs.has_episode == 'true'
        run: |
          EPID="${{ steps.episode.outputs.episode_id }}"
          MAX_ATTEMPTS=20
          INTERVAL=15
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $i/$MAX_ATTEMPTS: checking server.bysurf.tv for episode $EPID..."
            FOUND=$(curl -sL "https://server.bysurf.tv/bysurf_tv_data.json?nocache=${{ github.run_id }}_$i" | node -e "
              const id = process.argv[1];
              let data; try { data = JSON.parse(require('fs').readFileSync(0, 'utf8')); } catch(e) { process.exit(1); }
              const videos = data.videos || [];
              const found = videos.some(v => v && v.url && new RegExp('/(?:videos|video_embeds)/' + id).test(v.url));
              console.log(found ? 'yes' : 'no');
            " "$EPID" 2>/dev/null || echo "no")
            if [ "$FOUND" = "yes" ]; then
              echo "Episode $EPID is live on server.bysurf.tv."
              exit 0
            fi
            if [ $i -lt $MAX_ATTEMPTS ]; then
              echo "Not yet. Waiting ${INTERVAL}s..."
              sleep $INTERVAL
            fi
          done
          echo "::warning::Episode $EPID not found on server.bysurf.tv after ${MAX_ATTEMPTS} attempts. Discord preview may show default meta until server updates."
          exit 0

      - name: Notify Discord
        if: steps.episode.outputs.has_episode == 'true'
        run: |
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"content":"New Members Video is up now!\n<@&${{ secrets.DISCORD_SUPPORTERS_ROLE_ID }}>\nhttps://share.bysurf.tv/${{ steps.episode.outputs.episode_id }}","allowed_mentions":{"roles":["${{ secrets.DISCORD_SUPPORTERS_ROLE_ID }}"]}}'
